/*
Description : Handler class to update latitude and longitude
Author: sindhur
Date Of Creation: 11-12-2017
Modification Date:11-12-2017
*/
public class GenerateLocationTriggerHandler {
    // @future(callout=true)
    static public   List<Double> geocoding(Account geoAccount)
    { 
        List<Double> latlongList = new List<Double>();
        // Key for Google Maps Geocoding API
        String geocodingKey = 'AIzaSyCCCENxpWSZdHnLdXPbnKB0-vw3TYuhmxY';
        // get the passed in address 
        //create a string for the address to pass to Google Geocoding API
        String geoAddress = '';
        String Street='';
        String City='';
        String State='';
        String Country='';
        Street = geoAccount.BillingStreet;
        City = geoAccount.BillingCity;
        State = geoAccount.BillingState;
        Country = geoAccount.BillingCountry;
        if(geoAccount.BillingPostalCode != null){
            geoAddress += geoAccount.BillingPostalCode;
        }
        if(Street !='' && Street != null && City !='' && City != null && State !='' && State != null && Country !='' && Country != null 
           && geoAddress !='' && geoAddress != null){
               street =Street.replaceAll( '\\s+', '+');
               City =City.replaceAll( '\\s+', '+');
               State =State.replaceAll( '\\s+', '+');
               Country =Country.replaceAll( '\\s+', '+');
               System.debug('geoAddress '+geoAddress);
               System.debug('Street '+Street);
               System.debug('City '+City);
               System.debug('State '+State);
               System.debug('Country '+Country);
               //encode the string so we can pass it as part of URL
               geoAddress = EncodingUtil.urlEncode(geoAddress, 'UTF-8');
               //build and make the callout to the Geocoding API
               Http http = new Http();
               HttpRequest request = new HttpRequest();
               request.setEndpoint('https://maps.googleapis.com/maps/api/geocode/json?address='+Street+','+City+','+State+','+Country+','+geoAddress+'&key='+ geocodingKey+'&sensor=false');
               request.setMethod('GET');
               try {
                   //make the http callout
                   HttpResponse response = http.send(request);
                   // If the request is successful, parse the JSON response.
                   if (response.getStatusCode() == 200) {
                       //parse JSON to extract co-ordinates
                      System.debug('rebody'+ response.getBody());
                       JSONParser responseParser = JSON.createParser(response.getBody());
                       //iterate through loop to get lat & long
                       while(responseParser.nextToken() != null) {
                           if((responseParser.getCurrentToken() == JSONToken.FIELD_NAME) && (responseParser.getText() == 'location')) {
                               responseParser.nextToken();
                               while(responseParser.nextToken() != JSONToken.END_OBJECT) {
                                   String locationText = responseParser.getText();
                                   responseParser.nextToken();
                                   if (locationText == 'lat'){
                                       latlongList.add(responseParser.getDoubleValue());
                                      // geoAccount.Geo_Location__Latitude__s = responseParser.getDoubleValue();
                                   }
                                   else if (locationText == 'lng'){
                                       latlongList.add(responseParser.getDoubleValue());
                                      // geoAccount.Geo_Location__Longitude__s= responseParser.getDoubleValue();
                                   }
                               }
                           }
                       }//end of while
                   }//end of if
               }catch(Exception e) {
                   System.debug(LoggingLevel.ERROR,'Error Geocoding Address - ' + e.getMessage());
               }//end of try
           }//end of if     
        return latlongList;
    } //end of method
}//end of class
